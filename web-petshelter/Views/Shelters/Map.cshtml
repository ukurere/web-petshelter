@{
    ViewData["Title"] = "Shelters map";
    Layout = "_Layout";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<div id="map" style="height: calc(100vh - 140px); width: 100%;"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const uaCenter = [48.3794, 31.1656]; // центр України
    const map = L.map('map').setView(uaCenter, 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    (async function load() {
      try {
        const url = '@Url.Action("MapData", "Shelters")';
        const res = await fetch(url, { credentials: "same-origin" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const latlngs = [];

        data.forEach(s => {
          const lat = Number(s.lat), lng = Number(s.lng);
          if (Number.isFinite(lat) && Number.isFinite(lng)) {
            const m = L.marker([lat, lng])
              .addTo(map)
              .bindPopup(`<strong>${s.name}</strong><br>${s.address ?? ""}<br>
                          <a href="/Shelters/Details/${s.id}">Open</a>`);
            latlngs.push([lat, lng]);
          }
        });

        if (latlngs.length) {
          const bounds = L.latLngBounds(latlngs);
          map.fitBounds(bounds.pad(0.2));
        }
      } catch (e) {
        alert('Failed to load shelters.');
        console.error('Map load error:', e);
      }
    })();
</script>
